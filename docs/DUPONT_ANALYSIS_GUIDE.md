# æœé‚¦åˆ†æåŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

æœé‚¦åˆ†ææ˜¯ä¸€ç§ç»å…¸çš„è´¢åŠ¡åˆ†ææ–¹æ³•ï¼Œå°†å‡€èµ„äº§æ”¶ç›Šç‡(ROE)åˆ†è§£ä¸ºä¸‰ä¸ªå…³é”®é©±åŠ¨å› ç´ ï¼Œå¸®åŠ©æ·±å…¥ç†è§£å…¬å¸ç›ˆåˆ©èƒ½åŠ›çš„æ¥æºã€‚

### æ ¸å¿ƒå…¬å¼

```
ROE = èµ„äº§å‡€åˆ©ç‡ Ã— æƒç›Šä¹˜æ•°
    = (è¥ä¸šå‡€åˆ©æ¶¦ç‡ Ã— èµ„äº§å‘¨è½¬ç‡) Ã— (æ€»èµ„äº§ / è‚¡ä¸œæƒç›Š)
```

### å±‚çº§ç»“æ„

- **ç¬¬ä¸€å±‚**: ROE = ROA Ã— æƒç›Šä¹˜æ•°
- **ç¬¬äºŒå±‚**: ROA = è¥ä¸šå‡€åˆ©æ¶¦ç‡ Ã— èµ„äº§å‘¨è½¬ç‡
- **ç¬¬ä¸‰å±‚**: åŸºç¡€è´¢åŠ¡æ•°æ®ï¼ˆå‡€åˆ©æ¶¦ã€è¥ä¸šæ”¶å…¥ã€æ€»èµ„äº§ã€è‚¡ä¸œæƒç›Šç­‰ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‰ç«¯ä½¿ç”¨ï¼ˆStreamlitï¼‰

#### å¯åŠ¨åº”ç”¨

```bash
cd D:\Downloads\LlamaReportPro
streamlit run app.py
```

#### è®¿é—®æœé‚¦åˆ†æé¡µé¢

1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Streamlit åº”ç”¨
2. åœ¨ä¾§è¾¹æ é€‰æ‹© "ğŸ“Š æœé‚¦åˆ†æ" é¡µé¢
3. é€‰æ‹©æ•°æ®è¾“å…¥æ–¹å¼ï¼š
   - **æ‰‹åŠ¨è¾“å…¥**: ç›´æ¥è¾“å…¥è´¢åŠ¡æ•°æ®
   - **ä»å·²ä¸Šä¼ æ–‡æ¡£æå–**: ä»PDFè‡ªåŠ¨æå–
   - **ä½¿ç”¨ç¤ºä¾‹æ•°æ®**: å¿«é€Ÿæ¼”ç¤º

#### è¾“å…¥è´¢åŠ¡æ•°æ®

**å¿…éœ€æŒ‡æ ‡**:
- å‡€åˆ©æ¶¦ï¼ˆå…ƒï¼‰
- è¥ä¸šæ”¶å…¥ï¼ˆå…ƒï¼‰
- æ€»èµ„äº§ï¼ˆå…ƒï¼‰
- è‚¡ä¸œæƒç›Šï¼ˆå…ƒï¼‰
- æµåŠ¨èµ„äº§ï¼ˆå…ƒï¼‰
- éæµåŠ¨èµ„äº§ï¼ˆå…ƒï¼‰

**å¯é€‰æŒ‡æ ‡**:
- è¥ä¸šåˆ©æ¶¦ï¼ˆå…ƒï¼‰
- æ€»è´Ÿå€ºï¼ˆå…ƒï¼‰

#### ç”Ÿæˆåˆ†æ

1. ç‚¹å‡» "ğŸš€ ç”Ÿæˆæœé‚¦åˆ†æ" æŒ‰é’®
2. ç­‰å¾…åˆ†æå®Œæˆ
3. åˆ‡æ¢åˆ° "ğŸ“Š åˆ†æç»“æœ" æ ‡ç­¾é¡µæŸ¥çœ‹ç»“æœ
4. åˆ‡æ¢åˆ° "ğŸ“ˆ å¯è§†åŒ–" æ ‡ç­¾é¡µæŸ¥çœ‹å›¾è¡¨

---

### 2. åç«¯APIä½¿ç”¨ï¼ˆFastAPIï¼‰

#### å¯åŠ¨åç«¯æœåŠ¡

```bash
cd D:\Downloads\LlamaReportPro\llamareport-backend
python main.py
```

#### APIç«¯ç‚¹

**ç”Ÿæˆæœé‚¦åˆ†æ**

```http
POST /api/dupont-analysis
Content-Type: application/json

{
  "company_name": "ç¤ºä¾‹ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸",
  "report_year": "2023",
  "report_period": "2023å¹´åº¦",
  "financial_data": {
    "å‡€åˆ©æ¶¦": 1000000000,
    "è¥ä¸šæ”¶å…¥": 5000000000,
    "æ€»èµ„äº§": 10000000000,
    "è‚¡ä¸œæƒç›Š": 6000000000,
    "æµåŠ¨èµ„äº§": 4000000000,
    "éæµåŠ¨èµ„äº§": 6000000000
  }
}
```

**å“åº”ç¤ºä¾‹**

```json
{
  "company_name": "ç¤ºä¾‹ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸",
  "report_year": "2023",
  "report_period": "2023å¹´åº¦",
  "level1": {
    "roe": {
      "name": "å‡€èµ„äº§æ”¶ç›Šç‡",
      "value": "16.67",
      "formatted_value": "16.67%",
      "level": 1,
      "formula": "ROE = å‡€åˆ©æ¶¦ / è‚¡ä¸œæƒç›Š",
      "unit": "%"
    },
    "roa": {...},
    "equity_multiplier": {...}
  },
  "level2": {...},
  "level3": {...},
  "insights": [
    "å‡€èµ„äº§æ”¶ç›Šç‡ä¸º16.67%ï¼Œå¤„äºè‰¯å¥½æ°´å¹³ï¼Œè¡¨æ˜å…¬å¸ç›ˆåˆ©èƒ½åŠ›è¾ƒå¼º",
    "ROEä¸»è¦ç”±èµ„äº§å‡€åˆ©ç‡é©±åŠ¨ï¼Œå»ºè®®å…¬å¸æ³¨é‡èµ„äº§ä½¿ç”¨æ•ˆç‡å’Œç›ˆåˆ©èƒ½åŠ›"
  ],
  "strengths": [...],
  "weaknesses": [...],
  "recommendations": [...]
}
```

---

### 3. Pythonä»£ç ä½¿ç”¨

#### åŸºæœ¬ç”¨æ³•

```python
from utils.financial_calculator import DupontAnalyzer

# åˆ›å»ºåˆ†æå™¨
analyzer = DupontAnalyzer()

# å‡†å¤‡è´¢åŠ¡æ•°æ®
financial_data = {
    'å‡€åˆ©æ¶¦': 1000000000,  # 10äº¿å…ƒ
    'è¥ä¸šæ”¶å…¥': 5000000000,  # 50äº¿å…ƒ
    'æ€»èµ„äº§': 10000000000,  # 100äº¿å…ƒ
    'è‚¡ä¸œæƒç›Š': 6000000000,  # 60äº¿å…ƒ
    'æµåŠ¨èµ„äº§': 4000000000,  # 40äº¿å…ƒ
    'éæµåŠ¨èµ„äº§': 6000000000,  # 60äº¿å…ƒ
}

# æ‰§è¡Œæœé‚¦åˆ†æ
result = analyzer.calculate_dupont_analysis(
    financial_data=financial_data,
    company_name="ç¤ºä¾‹å…¬å¸",
    report_year="2023"
)

# è®¿é—®ç»“æœ
print(f"ROE: {result.level1.roe.formatted_value}")
print(f"ROA: {result.level1.roa.formatted_value}")
print(f"æƒç›Šä¹˜æ•°: {result.level1.equity_multiplier.formatted_value}")

# æŸ¥çœ‹AIæ´å¯Ÿ
for insight in result.insights:
    print(f"ğŸ’¡ {insight}")
```

#### ç”Ÿæˆå¯è§†åŒ–

```python
from utils.dupont_visualizer import create_dupont_sankey

# åˆ›å»ºSankeyå›¾
fig = create_dupont_sankey(result)

# ä¿å­˜ä¸ºHTML
fig.write_html("dupont_analysis.html")

# æˆ–åœ¨Jupyterä¸­æ˜¾ç¤º
fig.show()
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **Pydanticæ¨¡å‹** (`llamareport-backend/models/dupont_models.py`)
   - `DupontMetric`: å•ä¸ªæŒ‡æ ‡æ¨¡å‹
   - `DupontLevel1/2/3`: ä¸‰å±‚çº§æŒ‡æ ‡æ¨¡å‹
   - `DupontAnalysis`: å®Œæ•´åˆ†æç»“æœæ¨¡å‹
   - `DupontTreeNode`: æ ‘çŠ¶ç»“æ„æ¨¡å‹

2. **è®¡ç®—å¼•æ“** (`utils/financial_calculator.py`)
   - `DupontAnalyzer`: æœé‚¦åˆ†æè®¡ç®—å™¨
   - è‡ªåŠ¨æŒ‡æ ‡æ˜ å°„å’Œå½’ä¸€åŒ–
   - AIæ´å¯Ÿç”Ÿæˆ

3. **å·¥å…·å‡½æ•°** (`llamareport-backend/agents/dupont_tools.py`)
   - `generate_dupont_analysis()`: Agentå·¥å…·å‡½æ•°
   - `extract_financial_data_for_dupont()`: æ•°æ®æå–
   - `parse_financial_data_response()`: å“åº”è§£æ

4. **å¯è§†åŒ–ç»„ä»¶** (`utils/dupont_visualizer.py`)
   - `create_dupont_sankey()`: Sankeyæµç¨‹å›¾
   - `create_dupont_tree_chart()`: æ ‘çŠ¶å›¾
   - `create_dupont_bar_chart()`: æŸ±çŠ¶å›¾

5. **å‰ç«¯é¡µé¢** (`pages/dupont_analysis.py`)
   - Streamlitäº¤äº’ç•Œé¢
   - ä¸‰ç§æ•°æ®è¾“å…¥æ–¹å¼
   - å®æ—¶å¯è§†åŒ–å±•ç¤º

---

## ğŸ“ æ•°æ®æ ¼å¼è¯´æ˜

### è¾“å…¥æ•°æ®æ ¼å¼

æ”¯æŒå¤šç§æŒ‡æ ‡åç§°ï¼ˆè‡ªåŠ¨æ˜ å°„ï¼‰ï¼š

```python
{
    # å‡€åˆ©æ¶¦ï¼ˆå¿…éœ€ï¼‰
    'å‡€åˆ©æ¶¦': 1000000000,
    # æˆ– 'net_income', 'å½’æ¯å‡€åˆ©æ¶¦'
    
    # è¥ä¸šæ”¶å…¥ï¼ˆå¿…éœ€ï¼‰
    'è¥ä¸šæ”¶å…¥': 5000000000,
    # æˆ– 'revenue', 'è¥ä¸šæ€»æ”¶å…¥'
    
    # æ€»èµ„äº§ï¼ˆå¿…éœ€ï¼‰
    'æ€»èµ„äº§': 10000000000,
    # æˆ– 'total_assets'
    
    # è‚¡ä¸œæƒç›Šï¼ˆå¿…éœ€ï¼‰
    'è‚¡ä¸œæƒç›Š': 6000000000,
    # æˆ– 'equity', 'æ‰€æœ‰è€…æƒç›Š', 'shareholders_equity'
    
    # æµåŠ¨èµ„äº§ï¼ˆå¿…éœ€ï¼‰
    'æµåŠ¨èµ„äº§': 4000000000,
    # æˆ– 'current_assets'
    
    # éæµåŠ¨èµ„äº§ï¼ˆå¿…éœ€ï¼‰
    'éæµåŠ¨èµ„äº§': 6000000000,
    # æˆ– 'non_current_assets'
    
    # å¯é€‰æŒ‡æ ‡
    'è¥ä¸šåˆ©æ¶¦': 1200000000,
    'æ€»è´Ÿå€º': 4000000000
}
```

### è¾“å‡ºæ•°æ®ç»“æ„

```python
DupontAnalysis(
    company_name="å…¬å¸åç§°",
    report_year="2023",
    report_period="2023å¹´åº¦",
    level1=DupontLevel1(
        roe=DupontMetric(...),
        roa=DupontMetric(...),
        equity_multiplier=DupontMetric(...)
    ),
    level2=DupontLevel2(...),
    level3=DupontLevel3(...),
    tree_structure=DupontTreeNode(...),
    insights=["æ´å¯Ÿ1", "æ´å¯Ÿ2", ...],
    strengths=["ä¼˜åŠ¿1", "ä¼˜åŠ¿2", ...],
    weaknesses=["åŠ£åŠ¿1", "åŠ£åŠ¿2", ...],
    recommendations=["å»ºè®®1", "å»ºè®®2", ...],
    data_source="manual_input",
    extraction_method="direct",
    confidence_score=1.0
)
```

---

## ğŸ”§ Agenté›†æˆ

æœé‚¦åˆ†æå·²é›†æˆåˆ°FunctionAgentç³»ç»Ÿä¸­ï¼Œå¯é€šè¿‡è‡ªç„¶è¯­è¨€è°ƒç”¨ï¼š

```python
from llamareport_backend.agents.report_agent import ReportAgent

# åˆ›å»ºAgent
agent = ReportAgent(query_engine=query_engine)

# è‡ªç„¶è¯­è¨€è°ƒç”¨
response = agent.chat("è¯·ä¸ºXXå…¬å¸2023å¹´ç”Ÿæˆæœé‚¦åˆ†æ")

# Agentä¼šè‡ªåŠ¨ï¼š
# 1. ä»query_engineæå–è´¢åŠ¡æ•°æ®
# 2. è°ƒç”¨generate_dupont_analysiså·¥å…·
# 3. è¿”å›ç»“æ„åŒ–çš„æœé‚¦åˆ†æç»“æœ
```

---

## ğŸ“Š å¯è§†åŒ–ç±»å‹

### 1. Sankeyæµç¨‹å›¾

å±•ç¤ºå„æŒ‡æ ‡ä¹‹é—´çš„å±‚çº§å…³ç³»å’Œå½±å“è·¯å¾„ï¼Œæœ€ç›´è§‚åœ°å‘ˆç°æœé‚¦åˆ†æçš„åˆ†è§£é€»è¾‘ã€‚

**ç‰¹ç‚¹**:
- èŠ‚ç‚¹é¢œè‰²åŒºåˆ†ä¸åŒå±‚çº§
- æµé‡ç²—ç»†è¡¨ç¤ºå½±å“æƒé‡
- æ‚¬åœæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

### 2. æ ‘çŠ¶å›¾

ä»¥æ ‘çŠ¶ç»“æ„å±•ç¤ºæŒ‡æ ‡åˆ†è§£ï¼Œæ¸…æ™°å‘ˆç°çˆ¶å­å…³ç³»ã€‚

**ç‰¹ç‚¹**:
- å±‚çº§æ¸…æ™°
- é€’å½’å±•ç¤ºæ‰€æœ‰å­èŠ‚ç‚¹
- é€‚åˆæ‰“å°å’ŒæŠ¥å‘Š

### 3. æŒ‡æ ‡å¯¹æ¯”æŸ±çŠ¶å›¾

å¯¹æ¯”å„å±‚çº§å…³é”®æŒ‡æ ‡çš„æ•°å€¼ï¼Œä¾¿äºå¿«é€Ÿè¯†åˆ«å¼ºå¼±é¡¹ã€‚

**ç‰¹ç‚¹**:
- ç›´è§‚å¯¹æ¯”
- æ•°å€¼æ ‡æ³¨
- é¢œè‰²ç¼–ç 

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å•ä½**: æ‰€æœ‰è´¢åŠ¡æ•°æ®å•ä½ä¸º"å…ƒ"ï¼Œä¸è¦ä½¿ç”¨"ä¸‡å…ƒ"æˆ–"äº¿å…ƒ"
2. **æ•°æ®å®Œæ•´æ€§**: å¿…éœ€çš„6ä¸ªæŒ‡æ ‡å¿…é¡»å…¨éƒ¨æä¾›
3. **æ•°æ®åˆç†æ€§**: ç³»ç»Ÿä¼šéªŒè¯æ•°æ®çš„åˆç†æ€§ï¼ˆå¦‚æ€»èµ„äº§ = æµåŠ¨èµ„äº§ + éæµåŠ¨èµ„äº§ï¼‰
4. **ç²¾åº¦**: ä½¿ç”¨Decimalç±»å‹ç¡®ä¿è®¡ç®—ç²¾åº¦
5. **å…¼å®¹æ€§**: æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æŒ‡æ ‡åç§°

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: å¯¼å…¥é”™è¯¯

```
ModuleNotFoundError: No module named 'llamareport_backend'
```

**è§£å†³æ–¹æ¡ˆ**:
```python
import sys
from pathlib import Path

backend_path = Path(__file__).parent / "llamareport-backend"
sys.path.insert(0, str(backend_path))
```

### é—®é¢˜2: æ•°æ®éªŒè¯å¤±è´¥

```
ValidationError: æŒ‡æ ‡å€¼è¶…å‡ºåˆç†èŒƒå›´
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ•°æ®å•ä½æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä¸º"å…ƒ"ï¼‰
- ç¡®è®¤æ•°æ®æ˜¯å¦ä¸ºæ­£æ•°
- éªŒè¯æ€»èµ„äº§ = æµåŠ¨èµ„äº§ + éæµåŠ¨èµ„äº§

### é—®é¢˜3: å¯è§†åŒ–ä¸æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿å®‰è£…äº†plotly: `pip install plotly`
- æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒJavaScript
- å°è¯•ä½¿ç”¨ä¸åŒçš„å¯è§†åŒ–ç±»å‹

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [æœé‚¦åˆ†ææ³• - ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/æœé‚¦åˆ†ææ³•)
- [Plotly Sankey Diagrams](https://plotly.com/python/sankey-diagram/)
- [Pydantic Documentation](https://docs.pydantic.dev/)
- [LlamaIndex Documentation](https://docs.llamaindex.ai/)

---

## ğŸ‰ æ€»ç»“

æœé‚¦åˆ†æåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š

âœ… Pydantic v2æ•°æ®æ¨¡å‹
âœ… å®Œæ•´çš„è®¡ç®—å¼•æ“
âœ… Agentç³»ç»Ÿé›†æˆ
âœ… ä¸‰ç§å¯è§†åŒ–æ–¹å¼
âœ… Streamlitå‰ç«¯ç•Œé¢
âœ… FastAPIåç«¯æ¥å£
âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–

**æ‰€æœ‰æµ‹è¯•é€šè¿‡**: 5/5 âœ…

**ä¸å½±å“ç°æœ‰åŠŸèƒ½**: æ‰€æœ‰æ–°ä»£ç éƒ½æ˜¯å¢é‡æ·»åŠ ï¼Œæœªä¿®æ”¹ä»»ä½•ç°æœ‰åŠŸèƒ½ã€‚

