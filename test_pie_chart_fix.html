<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥¼å›¾ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }
        h2 {
            color: #666;
            margin-top: 30px;
        }
        .chart-box {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é¥¼å›¾æ¸²æŸ“ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•åç«¯è¿”å›çš„é¥¼å›¾æ•°æ®æ ¼å¼æ˜¯å¦èƒ½æ­£ç¡®æ¸²æŸ“</p>

        <h2>ğŸ“Š æµ‹è¯•åœºæ™¯</h2>
        
        <div class="info status">
            <strong>é—®é¢˜æè¿°ï¼š</strong><br>
            åç«¯ç”Ÿæˆé¥¼å›¾æ—¶ï¼Œå°†labelså­˜å‚¨åœ¨<code>trace.text</code>å­—æ®µä¸­ï¼Œä½†Plotlyé¥¼å›¾éœ€è¦<code>labels</code>å­—æ®µã€‚<br>
            ä¿®å¤åçš„ä»£ç ä¼šè‡ªåŠ¨å°†<code>trace.text</code>è½¬æ¢ä¸º<code>labels</code>ã€‚
        </div>

        <button onclick="testOriginalFormat()">æµ‹è¯•åŸå§‹æ ¼å¼ï¼ˆä¿®å¤å‰ä¼šå¤±è´¥ï¼‰</button>
        <button onclick="testFixedFormat()">æµ‹è¯•ä¿®å¤åæ ¼å¼</button>
        <button onclick="testBothFormats()">å¯¹æ¯”æµ‹è¯•</button>

        <div id="status"></div>

        <h2>ğŸ“ˆ æµ‹è¯•ç»“æœ</h2>
        
        <div class="chart-box">
            <h3>å›¾è¡¨1ï¼šä½¿ç”¨åç«¯è¿”å›çš„åŸå§‹æ ¼å¼ï¼ˆtextå­—æ®µï¼‰</h3>
            <div id="chart1"></div>
        </div>

        <div class="chart-box">
            <h3>å›¾è¡¨2ï¼šä½¿ç”¨ä¿®å¤åçš„æ ¼å¼ï¼ˆlabelså­—æ®µï¼‰</h3>
            <div id="chart2"></div>
        </div>

        <h2>ğŸ“ æ•°æ®æ ¼å¼å¯¹æ¯”</h2>
        <div id="dataComparison"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿåç«¯è¿”å›çš„é¥¼å›¾æ•°æ®ï¼ˆåŸå§‹æ ¼å¼ï¼‰
        const backendChartConfig = {
            "chart_type": "pie",
            "traces": [
                {
                    "name": "åˆ†å¸ƒ",
                    "x": [],
                    "y": [60, 45, 30, 15],
                    "type": "pie",
                    "text": ["ä¸»è¥ä¸šåŠ¡A", "ä¸»è¥ä¸šåŠ¡B", "ä¸»è¥ä¸šåŠ¡C", "å…¶ä»–ä¸šåŠ¡"],
                    "hovertemplate": "%{label}: %{value}äº¿å…ƒ (%{percent})<extra></extra>"
                }
            ],
            "layout": {
                "title": "å„ä¸šåŠ¡æ¿å—çš„æ”¶å…¥å æ¯” - åˆ†å¸ƒå›¾",
                "height": 500
            }
        };

        // ä¿®å¤å‰çš„æ¸²æŸ“å‡½æ•°ï¼ˆä¼šå¤±è´¥ï¼‰
        function renderChartOld(chartConfig, divId) {
            try {
                const traces = chartConfig.traces.map(trace => {
                    const plotlyTrace = {
                        x: trace.x || [],
                        y: trace.y || [],
                        type: trace.type || 'scatter',
                        name: trace.name || 'æ•°æ®',
                    };

                    if (trace.text) plotlyTrace.text = trace.text;
                    if (trace.hovertemplate) plotlyTrace.hovertemplate = trace.hovertemplate;

                    return plotlyTrace;
                });

                const layout = {
                    title: chartConfig.layout.title || '',
                    height: chartConfig.layout.height || 500
                };

                Plotly.newPlot(divId, traces, layout);
                return true;
            } catch (error) {
                console.error('æ¸²æŸ“å¤±è´¥:', error);
                document.getElementById(divId).innerHTML = `<div class="error status">âŒ æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
                return false;
            }
        }

        // ä¿®å¤åçš„æ¸²æŸ“å‡½æ•°
        function renderChartFixed(chartConfig, divId) {
            try {
                const traces = chartConfig.traces.map(trace => {
                    const plotlyTrace = {
                        type: trace.type || 'scatter',
                        name: trace.name || 'æ•°æ®',
                    };

                    // ç‰¹æ®Šå¤„ç†é¥¼å›¾
                    if (trace.type === 'pie') {
                        plotlyTrace.labels = trace.text || [];
                        plotlyTrace.values = trace.y || [];
                    } else {
                        plotlyTrace.x = trace.x || [];
                        plotlyTrace.y = trace.y || [];
                    }

                    if (trace.type !== 'pie' && trace.text) {
                        plotlyTrace.text = trace.text;
                    }
                    
                    if (trace.hovertemplate) plotlyTrace.hovertemplate = trace.hovertemplate;

                    return plotlyTrace;
                });

                const layout = {
                    title: chartConfig.layout.title || '',
                    height: chartConfig.layout.height || 500
                };

                Plotly.newPlot(divId, traces, layout);
                return true;
            } catch (error) {
                console.error('æ¸²æŸ“å¤±è´¥:', error);
                document.getElementById(divId).innerHTML = `<div class="error status">âŒ æ¸²æŸ“å¤±è´¥: ${error.message}</div>`;
                return false;
            }
        }

        function testOriginalFormat() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="info status">â³ æµ‹è¯•åŸå§‹æ ¼å¼ï¼ˆä¿®å¤å‰ï¼‰...</div>';
            
            const success = renderChartOld(backendChartConfig, 'chart1');
            
            if (success) {
                status.innerHTML = '<div class="error status">âš ï¸ åŸå§‹æ ¼å¼æ¸²æŸ“æˆåŠŸï¼Œä½†å¯èƒ½æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆlabelsç¼ºå¤±ï¼‰</div>';
            } else {
                status.innerHTML = '<div class="error status">âŒ åŸå§‹æ ¼å¼æ¸²æŸ“å¤±è´¥ï¼ˆé¢„æœŸç»“æœï¼‰</div>';
            }
        }

        function testFixedFormat() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="info status">â³ æµ‹è¯•ä¿®å¤åæ ¼å¼...</div>';
            
            const success = renderChartFixed(backendChartConfig, 'chart2');
            
            if (success) {
                status.innerHTML = '<div class="success status">âœ… ä¿®å¤åæ ¼å¼æ¸²æŸ“æˆåŠŸï¼é¥¼å›¾åº”è¯¥æ­£ç¡®æ˜¾ç¤ºlabelså’Œvalues</div>';
            } else {
                status.innerHTML = '<div class="error status">âŒ ä¿®å¤åæ ¼å¼æ¸²æŸ“å¤±è´¥ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰</div>';
            }
        }

        function testBothFormats() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="info status">â³ å¯¹æ¯”æµ‹è¯•ä¸­...</div>';
            
            const oldSuccess = renderChartOld(backendChartConfig, 'chart1');
            const fixedSuccess = renderChartFixed(backendChartConfig, 'chart2');
            
            let message = '<h3>æµ‹è¯•ç»“æœå¯¹æ¯”ï¼š</h3>';
            message += `<p>ä¿®å¤å‰ï¼š${oldSuccess ? 'âš ï¸ æ¸²æŸ“ä½†å¯èƒ½ä¸æ­£ç¡®' : 'âŒ å¤±è´¥'}</p>`;
            message += `<p>ä¿®å¤åï¼š${fixedSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>`;
            
            if (fixedSuccess) {
                message += '<div class="success status">âœ… ä¿®å¤æˆåŠŸï¼å›¾è¡¨2åº”è¯¥æ­£ç¡®æ˜¾ç¤ºé¥¼å›¾</div>';
            }
            
            status.innerHTML = message;
            
            // æ˜¾ç¤ºæ•°æ®æ ¼å¼å¯¹æ¯”
            showDataComparison();
        }

        function showDataComparison() {
            const comparison = document.getElementById('dataComparison');
            
            const originalTrace = {
                x: [],
                y: [60, 45, 30, 15],
                type: 'pie',
                text: ["ä¸»è¥ä¸šåŠ¡A", "ä¸»è¥ä¸šåŠ¡B", "ä¸»è¥ä¸šåŠ¡C", "å…¶ä»–ä¸šåŠ¡"]
            };
            
            const fixedTrace = {
                type: 'pie',
                labels: ["ä¸»è¥ä¸šåŠ¡A", "ä¸»è¥ä¸šåŠ¡B", "ä¸»è¥ä¸šåŠ¡C", "å…¶ä»–ä¸šåŠ¡"],
                values: [60, 45, 30, 15]
            };
            
            comparison.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>âŒ ä¿®å¤å‰ï¼ˆåç«¯è¿”å›æ ¼å¼ï¼‰</h4>
                        <pre>${JSON.stringify(originalTrace, null, 2)}</pre>
                        <p class="error status">é—®é¢˜ï¼šPlotlyé¥¼å›¾éœ€è¦<code>labels</code>å­—æ®µï¼Œä½†æ•°æ®åœ¨<code>text</code>å­—æ®µä¸­</p>
                    </div>
                    <div>
                        <h4>âœ… ä¿®å¤åï¼ˆè½¬æ¢åæ ¼å¼ï¼‰</h4>
                        <pre>${JSON.stringify(fixedTrace, null, 2)}</pre>
                        <p class="success status">è§£å†³ï¼šå°†<code>text</code>è½¬æ¢ä¸º<code>labels</code>ï¼Œ<code>y</code>è½¬æ¢ä¸º<code>values</code></p>
                    </div>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œå¯¹æ¯”æµ‹è¯•
        window.onload = function() {
            testBothFormats();
        };
    </script>
</body>
</html>

